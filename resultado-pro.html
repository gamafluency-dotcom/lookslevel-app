<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relatório Pro | LooksLevel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: { extend: { colors: { dark: { bg: '#0F0F0F', card: '#1F1F1F' }, brand: { red: '#FF0033', deep: '#8A0303' } } } }
        }
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>body { font-family: 'Inter', sans-serif; }</style>
</head>
<body class="bg-dark-bg text-gray-200 min-h-screen flex flex-col items-center justify-center p-4">

    <div id="uploadSection" class="max-w-md w-full bg-dark-card p-8 rounded-3xl border border-brand-red/30 shadow-[0_0_30px_rgba(255,0,51,0.1)] text-center animate-fade-in">
        <div class="w-16 h-16 bg-green-500/20 text-green-500 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl border border-green-500/50">
            <i class="fas fa-check"></i>
        </div>
        <h1 class="text-2xl font-bold text-white mb-2">Pagamento Confirmado!</h1>
        <p class="text-sm text-gray-400 mb-6">Sua licença PRO foi ativada. Carregue suas fotos para gerar o relatório.</p>

        <input type="file" id="finalPhotos" multiple accept="image/*" class="hidden" onchange="handleFinalUpload(this.files)">
        
        <button id="uploadBtn" onclick="document.getElementById('finalPhotos').click()" class="w-full bg-gradient-to-r from-brand-red to-brand-deep text-white font-bold py-4 rounded-xl shadow-lg hover:brightness-110 transition transform active:scale-95">
            <i class="fas fa-magic mr-2"></i> Gerar Análise Agora
        </button>
        
        <div id="loadingStatus" class="hidden mt-6">
            <div class="w-full bg-black rounded-full h-2 mb-2 overflow-hidden">
                <div class="bg-brand-red h-full w-1/3 animate-pulse"></div>
            </div>
            <p id="statusText" class="text-xs text-brand-red animate-pulse">Otimizando imagens...</p>
        </div>
    </div>

    <div id="resultSection" class="hidden max-w-md w-full bg-dark-card p-6 rounded-3xl border border-gray-800 shadow-2xl relative">
        <div class="absolute top-0 right-0 bg-brand-red text-white text-[10px] font-bold px-3 py-1 rounded-bl-xl rounded-tr-3xl">PRO VERIFIED</div>
        
        <h2 class="text-center text-xl font-bold text-white mb-6">Relatório Oficial LooksLevel</h2>
        
        <div class="flex justify-between items-end mb-6 bg-black/40 p-5 rounded-2xl border border-gray-800">
            <div class="text-center w-1/2 border-r border-gray-700">
                <p class="text-[10px] text-gray-500 uppercase tracking-widest mb-1">Nota Atual</p>
                <span id="scoreVal" class="text-5xl font-black text-white">--</span>
            </div>
            <div class="text-center w-1/2">
                <p class="text-[10px] text-gray-500 uppercase tracking-widest mb-1">Potencial</p>
                <span id="potentialVal" class="text-5xl font-black text-brand-red">--</span>
            </div>
        </div>

        <div class="bg-dark-bg p-5 rounded-2xl border border-gray-800 mb-6">
            <h3 class="text-brand-red font-bold text-sm mb-3 flex items-center gap-2">
                <i class="fas fa-microscope"></i> Análise Técnica
            </h3>
            <p id="aiComment" class="text-sm text-gray-300 leading-relaxed text-justify">
                Aguardando análise...
            </p>
        </div>

        <button onclick="window.print()" class="w-full py-3 bg-white text-black font-bold rounded-xl hover:bg-gray-200 transition">
            Salvar Relatório em PDF <i class="fas fa-download ml-2"></i>
        </button>
    </div>

    <script>
        // Função para comprimir imagem antes de enviar (Resolve o problema de tamanho)
        const compressImage = (file) => {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        // Redimensiona para no máximo 800px (suficiente para IA)
                        const scaleSize = 800 / Math.max(img.width, img.height);
                        canvas.width = img.width * Math.min(1, scaleSize);
                        canvas.height = img.height * Math.min(1, scaleSize);
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        // Comprime para JPEG 0.7
                        resolve(canvas.toDataURL('image/jpeg', 0.7));
                    };
                };
            });
        };

        async function handleFinalUpload(files) {
            if(files.length < 1) return;

            document.getElementById('uploadBtn').classList.add('hidden');
            document.getElementById('loadingStatus').classList.remove('hidden');
            document.getElementById('statusText').innerText = "Otimizando imagens para IA...";

            try {
                // 1. Comprimir todas as imagens
                const compressionPromises = Array.from(files).slice(0,3).map(file => compressImage(file));
                const base64Images = await Promise.all(compressionPromises);

                document.getElementById('statusText').innerText = "Analisando estrutura facial...";

                // 2. Enviar
                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ photos: base64Images })
                });

                const data = await response.json();

                if(data.error) throw new Error(data.error);

                // 3. Mostrar Resultado
                document.getElementById('scoreVal').innerText = data.score;
                document.getElementById('potentialVal').innerText = data.potential;
                document.getElementById('aiComment').innerText = data.comment;

                document.getElementById('uploadSection').classList.add('hidden');
                document.getElementById('resultSection').classList.remove('hidden');

            } catch (error) {
                alert("Ocorreu um erro: " + error.message);
                location.reload();
            }
        }
    </script>
</body>
</html>
